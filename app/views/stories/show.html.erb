<div>
  <div class="chart-body" id="chart-body" style="display:none">
    <div class="relative" id="chart-main-middle">
      <div class="chart-container " id="chart-container"></div>
    </div>
  </div>
</div>
<div class="chart-conditions">
  <% @chart_conditions.each_with_index do |cc, i| %>
      <div>
        <input type="hidden" value="<%= cc.kpi_id %>" id="kpi-id-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.kpi_name %>" id="kpi-name-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.entity_group_id %>" id="entity-group-id-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.entity_group_name %>" id="entity-group-name-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.start_time %>" id="start-time-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.end_time %>" id="end-time-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.interval %>" id="frequency-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.chart_type %>" id="type-hidden-<%= i %>"/>
        <input type="hidden" value="<%= cc.cache_data %>" id="data-hidden-<%= i %>"/>
      </div>
  <% end %>
</div>
<% content_for :javascript_includes do%>
    <%= javascript_include_tag "highstock.js"%>
    <%= javascript_include_tag "high_chart_template_analytic.js"%>
    <%= javascript_include_tag "Analytics_init.js"%>
<%end%>
<script>
    $(document).ready(function () {
        for (var i = 0; i < $('.chart-conditions').children().length; i++)
            prepare_form_cchart(i);
    });
    function prepare_form_cchart(i) {
        var data = jQuery.parseJSON($("#data-hidden-"+i).val());
        var kpi = $("#kpi-id-hidden-"+i).val();
        var kpi_name = $("#kpi-name-hidden-"+i).val();
        var view = $("#entity-group-id-hidden-"+i).val();
        var view_text = $("#entity-group-name-hidden-"+i).val();
        var interval = $("#frequency-hidden-"+i).val(), type = $("#type-hidden-"+i).val(), chart_body_close_validate;
        var begin_time = $("#start-time-hidden-"+i).val(), end_time = $("#end-time-hidden-"+i).val();
        if ($("#chart-body").css("display") == "block") {
            chart_body_close_validate = false;
        } else {
            chart_body_close_validate = true;
        }
        if (kpi && begin_time && view) {
            if (end_time) {
                var compare_result = compare_time(begin_time, end_time);
                begin_time = compare_result.begin;
                end_time = compare_result.end;
            } else {
                end_time = begin_time
            }
            var option = {
                show_loading: false,
                kpi: kpi_name,
                kpi_id: kpi,
                target: "chart-container",
                begin_time: begin_time,
                end_time: end_time,
                type: type,
                interval: interval,
                count: ANALYTICS.chartSeries.count + 1,
                view: view,
                view_text: view_text,
                chart_body_close_validate: chart_body_close_validate
            };
            ANALYTICS.chartSeries.addCount();
            ANALYTICS.chartSeries.id_give();
            option.id = ANALYTICS.chartSeries.id;
            ANALYTICS.chartSeries.addSeries(option);
            if (option.chart_body_close_validate) {
                show_chart_body(option);
            }
            ANALYTICS.form_chart_without_ajax(option, data);
        }
    }
</script>

<p id="notice"><%= notice %></p>
<p>
  <b>Title:</b>
  <%= @story.title %>
</p>
<input type="hidden" id="current-story" value="<%= @story.id %>">
<div>
  <p>Comment:</p>

  <div>
    <textarea id="comment-content" rows="3" cols="20"></textarea>
  </div>
  <div>
    <div>
      <p>Attachment</p>
      <input id="comment-item-data-uploader" type="file" name="files[]" multiple="true" data-url="/files/upload">

      <div class="abstractblock" id="comment-item-data-uploader" style="display:none;"></div>
    </div>
  </div>
  <input type="button" onclick="create_comment();">
</div>

