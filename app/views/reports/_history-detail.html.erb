<style>
  #chart_mode {
    text-align: right;
    z-index: 1000;
  }

  .change_charts {
    width: 100px;
    font-size: 1.5em;
    background: transparent;
    border: 1px solid #999;
    opacity: .5;
    margin-left: -5px;
  }

  .change_charts:hover {
    opacity: .8;
  }

  .change_charts:first-child {
    border-top-left-radius: 15px;
    border-bottom-left-radius: 15px;
  }

  .change_charts:last-child {
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
  }

  input[type='text'] {
    width: 150px;
    text-align: center;
  }

  .table > thead > tr > th, .table > tbody > tr > td {
    text-align: center;
    background: white;
  }

  .highcharts-scrollbar > rect:first-child {
    fill: steelblue;
    stroke-width: 1;
    stroke: #36648B;
  }

  .highcharts-scrollbar > rect:first-child + rect {
    fill: #4F94CD;
    stroke-width: 0;
  }

  .highcharts-scrollbar > g > rect {
    fill: #4F94CD;
    stroke-width: 0;
  }

  .highcharts-scrollbar > g > path {
    fill: steelblue;
  }
</style>

<div class="col-sm-12" style="background:#4682B4;color:white; border-bottom: 4px solid #ffffff;height: 70px;line-height: 20px;padding-top:15px;text-align: center;">
  <div class="col-sm-3" style="border-right: 1px solid #ccc;margin-top: -5px;">
    <label>Condition</label>
    <p style="padding-bottom: 5px;">Cycle Time History Line Chart</p>
  </div>
  <div class="col-sm-6" style="display: flex;text-align: center;border-right: 1px solid #ccc;padding-left:30px;">
    <input type="text" readonly class="datetimepicker" style="width: 160px;" id="start_time" title="Start Time">&emsp;
    <b>~</b> &emsp;
    <input type="text" readonly style="width: 160px;" class="datetimepicker" id="end_time" title="End Time">
    <button class="btn btn-primary historty_search" style="width: 100px;">Search</button>
  </div>

  <div class="col-sm-3">
    <input type="button" onclick="go_back()" value="Back" class="btn btn-success" style="width: 100px;margin-left: 60px;"/>
  </div>
</div>

<div class="col-sm-12 SumTotal">
  <div class="col-sm-5" style="display: flex; display: -ms-flexbox; height: 30px;line-height: 30px;">
    <p style="color: white;">Total: &emsp; </p><b id="total_data" style="margin-right: 20px;color:white;">0</b>
    <p style="color:white;">Normal: &emsp; </p><b id="normal_data" style="color: limegreen;">0</b>
    <p style="margin-left:20px; color:white;">Exception:&emsp; </p><b id="abnormal_data" style="color: #ff0000;">0</b>
  </div>

  <!--<div id="chart_mode">-->
  <!--<button class="change_charts" style="opacity: 1;color: orange;border-color: orange;">line</button>-->
  <!--<button class="change_charts">column</button>-->
  <!--<button class="change_charts">scatter</button>-->
  <!--</div>-->
</div>
<div class="col-sm-12" style="padding: 0;">
  <div id="history_chart"></div>
</div>
<!--table-->
<div class="col-sm-12">
  <div id="history_table" style="margin-top: 20px; display: none;">
    <table class="table table-bordered table-hover">
      <thead>
      <tr class="history_table_thead_tr">
      </tr>
      </thead>
      <tbody class="history_table_tbody_tr">
      <tr class="history_table_tbody_target_min">
      </tr>
      <tr class="history_table_tbody_value">
      </tr>
      <tr class="history_table_tbody_target_max">
      </tr>
      </tbody>
    </table>
  </div>
</div>

<% content_for :javascript_includes do %>
    <%= javascript_include_tag "jedate" %>
<% end %>

<script type="text/javascript" charset="utf-8">
  // 固定不变
  var box_name = localStorage.box_name;
  var box_msg = localStorage.box_msg;
  var change_pre_url = localStorage.pre_url;

  function go_back() {
    try {
      if (change_pre_url == 'undefined') {
        change_pre_url = window.location.host + '/reports#current_status';
        window.location.href = "/reports?from_ipad=true&part=1";
      } else if (change_pre_url.split('#')[1] == "defects") {
        change_pre_url = window.location.host + '/reports#current_status';
        window.location.href = "/reports?from_ipad=true&part=1";
      } else if (change_pre_url.split('#')[1] == "current_status") {
        window.location.href = "/reports?from_ipad=true&part=1";
      } else if (change_pre_url.split('#')[1] == "daily_ftq") {
        window.location.href = "/reports?from_ipad=true&part=8";
      }
    } catch (e) {
      console.log(e);
      alert(e);
    }
  }

  var ChartStyle = {
    ChartBackground: "#4682B4",
    label_font_color: "white",
    tooltips_font_color: "black"
  };

  var IpadHeight = document.documentElement.clientHeight;

  $('#report-content').css({
    height: (IpadHeight + 125) + 'px',
    overflow: 'hidden'
  });

  $('.SumTotal').css({
    background: "#4682B4"
  });

  $('#history_chart').css({
    height: (IpadHeight - 50) + 'px'
  });

  var BoxID = $('#entity_group_id').val();
  var pre_time = new Date().format('yyyy-MM-dd').toString() + ' ' + '00:00:00';
  var current_time = new Date().format('yyyy-MM-dd hh:mm:ss');
  $('#start_time').attr('value', pre_time);
  $('#end_time').attr('value', current_time);

  GetHistoryDataFun(BoxID, pre_time, current_time);

  function loadHistoryDataFun(HistoryDataName, HistoryData) {
    var normal_data = 0;
    var abnormal_data = 0;

    $('#report-menu').remove();
    $('#pop-crate').remove();
    /*清空*/
    $('#history_chart').children().remove();
    $('.history_table_thead_tr').children().remove();
    $('.history_table_tbody_target_max').children().remove();
    $('.history_table_tbody_target_min').children().remove();
    $('.history_table_tbody_value').children().remove();

    // 定义变量
    var xAxis_value = new Array();
    var history_target_max = new Array();
    var history_value = new Array();

    // 绘制表头
    $('<th>Time</th>').appendTo('.history_table_thead_tr').ready(function () {
    });

    $('<td>TargetMax</td>').appendTo('.history_table_tbody_target_max').ready(function () {
    });

    $('<td>Value</td>').appendTo('.history_table_tbody_value').ready(function () {
    });

    // 循环添加数据
    var data_entry_at_format_all = "";
    var data_entry_at_format_all_date = new Array();
    for (var i = 0; i < HistoryData.length; i++) {
      var data_id = HistoryData[i].id;
      var data_value = HistoryData[i].value;

      var data_entry_at = HistoryData[i].entry_at;
      data_entry_at_format_all = new Date(data_entry_at).format('yyyy-MM-dd hh:mm:ss');
      data_entry_at_format_all_date.push(data_entry_at_format_all);

      var data_entry_at_format = new Date(data_entry_at).format('hh:mm:ss');
      xAxis_value.push(data_entry_at_format);

      var data_target_max = HistoryData[i].target_max;
      history_target_max.push({id: data_entry_at_format_all_date[i], y: data_target_max});

      var data_target_min = HistoryData[i].target_min;

      $('<th>' + data_entry_at_format_all + '</th>').appendTo('.history_table_thead_tr').ready(function () {
      });

      $('<td>' + data_target_max + '</td>').appendTo('.history_table_tbody_target_max').ready(function () {
      });

      var data_value = HistoryData[i].value;
      if (data_value > data_target_max) {
        history_value.push({id: data_entry_at_format_all_date[i], color: '#ff0000', y: data_value});
        $('<td style="background:#ff0000;">' + data_value + '</td>').appendTo('.history_table_tbody_value').ready(function () {
        });
        abnormal_data++;
      } else {
        history_value.push({id: data_entry_at_format_all_date[i], color: 'limegreen', y: data_value});
        $('<td style="background:limegreen;">' + data_value + '</td>').appendTo('.history_table_tbody_value').ready(function () {
        });
        normal_data++;
      }
    }

    var max_count = 25;
    if (HistoryData.length < max_count) {
      max_count = HistoryData.length;
    }

    $('#normal_data').html(normal_data);
    $('#abnormal_data').html(abnormal_data);
    $('#total_data').html(normal_data + abnormal_data);

    // 图表操作
    var chart_options = {
      chart: {
        renderTo: 'history_chart',
        backgroundColor: ChartStyle.ChartBackground
      },
      credits: {
        enabled: false
      },
      title: {
        text: HistoryDataName,
        x: -20,
        style: {
          color: ChartStyle.label_font_color
        }
      },
      subtitle: {
        text: '——History Data',
        x: 20,
        style: {
          color: ChartStyle.label_font_color
        }
      },
      xAxis: {
        categories: xAxis_value,
        max: max_count,
        labels: {
          style: {
            color: ChartStyle.label_font_color
          }
        }
      },
      yAxis: {
        title: {
          text: 'Time(s)',
          style: {
            color: ChartStyle.label_font_color
          }
        },
        plotLines: [{value: 0, width: 1, color: ChartStyle.label_font_color}],
        labels: {
          style: {
            color: ChartStyle.label_font_color
          }
        }
      },
      tooltip: {
        formatter: function () {
          return '<span><b>' + this.point.id + '</b><br/><b>Value:</b><b>' + this.y + ' s</b><span>';
        },
        style: {
          color: ChartStyle.tooltips_font_color
        }
      },
      scrollbar: {
        enabled: true
      },
      legend: {
        layout: 'horizontal',
        align: 'center',
        verticalAlign: 'bottom',
        borderHeight: 0,
        itemStyle: {
          color: ChartStyle.label_font_color
        }
      },
      plotOptions: {
        series: {
          stickyTracking: false,
          turboThreshold: 0 //不限制数据点个数
        }
      },
      series: [{
        name: 'Value',
        data: history_value,
        /* date color : green*/
        color: 'limegreen'
      }, {
        type: 'line',
        name: 'TargetMax',
        data: history_target_max,
        /*orange*/
        color: '#FF7F00'
      }]
    };

    var chart = new Highcharts.Chart(chart_options);

    /*change chart type.*/
    $("button.change_charts").click(function () {
      $('.change_charts').css({
        opacity: 0.3,
        color: 'black',
        borderColor: 'black'
      });
      $(this).css({
        opacity: 1,
        color: 'orange',
        borderColor: 'orange'
      });
      var type = $(this).html();
      chart_options.chart.type = type;
      chart = new Highcharts.Chart(chart_options);
    });
  }

  $(document).ready(function () {
    // 保证 没有 残影
    $('#report-menu').css({display: 'none'});
    $('#pop-crate').css({left: 0});

    var ClientHeight = $(document).height();
    var ClientWidth = document.documentElement.clientWidth;

    $('#report-content').css({
      height: (ClientHeight - 70) + 'px',
      overflow: 'auto'
    });

    $('#history_table').css({width: (ClientWidth - 20) + 'px', overflowX: 'auto'});

    jeDate({
      dateCell: "#start_time",
      isinitVal: true,
      isTime: true, //isClear:false,
      minDate: "2014-09-19 00:00:00"
    });

    jeDate({
      dateCell: "#end_time",
      isinitVal: true,
      isTime: true, //isClear:false,
      minDate: "2014-09-19 00:00:00"
    });

    $('.historty_search').click(function () {
      $('.change_charts').css({
        opacity: 0.3,
        color: 'black',
        borderColor: 'black'
      });

      $('.change_charts:first-child').css({opacity: 1, color: 'orange', borderColor: 'orange'});

      var search_start_time = $('#start_time').val();
      var search_end_time = $('#end_time').val();
      var search_id = BoxID;

      if (search_start_time > search_end_time) {
        var time = search_start_time;
        search_start_time = search_end_time;
        search_end_time = time;
      }

      GetHistoryDataFun(search_id, search_start_time, search_end_time);
    });
  });

  /*get data*/
  function GetHistoryDataFun(id, start_time, end_time) {
    show_loading(145, 0, 0, 10);
    $.ajax({
      url: '/departments/cycle_kpi_history',
      type: 'get',
      data: {id: id, start_time: start_time, end_time: end_time},
      success: function (data) {
        var SearchHistoryData = data;   //GetHistoryData = data;
        var SearchHistoryDataName = SearchHistoryData.name;
        var SearchHistoryDataID = SearchHistoryData.id;
        var SearchHistoryDataValue = SearchHistoryData.data;

        if (SearchHistoryDataValue.length == 0) {
          if ($('#from_ipad').val()) {
            $('body').css({
              background: "steelblue"
            })
          } else {
            alert('This period of time there is no data, modify the query date.');
          }
        } else {
          loadHistoryDataFun(SearchHistoryDataName, SearchHistoryDataValue);
        }
        remove_loading();
      },
      error: function () {
        console.log("something error");
      }
    });
  }
</script>