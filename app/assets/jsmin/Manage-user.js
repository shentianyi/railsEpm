var MANAGE=MANAGE||{};MANAGE.user={},MANAGE.user.icheck={},MANAGE.user.init=function(){MANAGE.user.user_add_box_bind(),MANAGE.user.user_add_clear(),MANAGE.user.icheck.init(),MANAGE.user.assign.init(),$(".single-select").chosen({allow_single_deselect:!0}),$("body").on("click","#add-user-show",function(){$("#manage-user-add").css("right","261px"),$("#manage-right-content").css("padding-right","200px"),$("#left-content-title").css("margin-right","201px"),$("#user-edit").css("left","-250px"),$("#manage-right-content").css("padding-left","0px"),$("#manage-user-add.create-user> div >.div-select>div").css("width","150px")}).on("click","#manage-user-edit",function(){$("#user-edit").css("left","0px"),$("#manage-right-content").css("padding-left","200px"),$("#manage-user-add").css("right","999em"),$("#manage-right-content").css("padding-right","0px"),$("#left-content-title").css("margin-right","0px"),MANAGE.user.user_edit_box_bind(),$("#user-edit> div >.div-select>div").css("width","150px")}),$("#manage-user-edit-old").on("click",function(){MANAGE.user.edit()}),$("#department-for-kpi").val("").trigger("chosen:updated"),$("#manage-user-add").height($(document).height()-$("header").height()),$(window).resize(function(){$("#manage-user-add").height($(document).height()-$("header").height())})},MANAGE.user.icheck.init=function(){$("#manage-sort-list input[type='checkbox']").on("ifChecked",function(){$("#manage-sort-list input[type='checkbox']").filter(function(){return $(this).parent().hasClass("checked")}).iCheck("uncheck")}),$("#manage-sort-list input[type='checkbox']").on("ifUnchecked",function(){1==$("#manage-sort-list .icheckbox_minimal-aero.checked").length&&"-200px"!=$("#user-edit").css("left")&&($("#user-edit").css("left","-250px"),$("#manage-right-content").css("padding-left","0px"),MANAGE.user.user_add_clear())})},MANAGE.user.user_add_box_bind=function(){$("body").on("click","#close-add-user[general='close-user']",function(){MANAGE.user.user_add_close()}),$("body").on("click","#close-user-edit[general='close-user']",function(){MANAGE.user.user_edit_close()}),$("#manage-user-add-new").on("click",function(){MANAGE.user.add_new()}),$("#new-user-password-confirm").blur(function(){$(this).val()!=$("#new-user-password").val()?$(this).css("borderColor","#fa4545").attr("red",!0):$(this).css("borderColor","#ddd").attr("red",!1)}),$("[general='user-mail']").blur(function(){isEmail($(this).val())?$(this).css("borderColor","#ddd").attr("red",!1):$(this).css("borderColor","#fa4545").attr("red",!0)})},MANAGE.user.user_add_close=function(){$("#manage-user-add").css("right","999em"),$("#manage-right-content").css("padding-right","0px"),$("#left-content-title").css("margin-right","0px"),MANAGE.user.user_add_clear()},MANAGE.user.user_edit_close=function(){$("#user-edit").css("left","-250px"),$("#manage-right-content").css("padding-left","0px"),MANAGE.user.user_add_clear()},MANAGE.user.user_add_clear=function(){$("[general='manage-user-add'] input[type='text']").val(""),$("[general='manage-user-add'] input[type='password']").val(""),$("[general='manage-user-add'] select").val("").trigger("chosen:updated"),$("[general='manage-user-add'] input[type='radio']").iCheck("uncheck"),$("[general='manage-user-add']>div>input").filter("[red='true']").css("borderColor","#ddd").attr("red","false"),$("#manage-user-add input[type='radio']").first().iCheck("check"),$("#user-edit input[type='radio']").first().iCheck("check")},MANAGE.user.add_new=function(){var name=$("#new-user-name").val(),entity_id=($("#department-for-kpi :selected").text(),$("#entity-for-kpi :selected").attr("value")),department_id=$("#department-for-kpi :selected").attr("value"),department_name=$("#department-for-kpi :selected").text();console.log(department_id);{var entity_name=$("#entity-for-kpi :selected").text(),mail=$("#new-user-mail").val(),title=$("#new-user-title").val(),password=$("#new-user-password").val(),password_confirm=$("#new-user-password-confirm").val(),role=$("input[name='user-role']:checked").attr("value");$("input[name='user-role']:checked").data("name")}$.trim(name).length>0&&mail.length>0&&password.length>0&&password_confirm.length>0?$.ajax({url:"/users",data:{user:{first_name:name,email:mail,title:title,password:password,password_confirmation:password_confirm,entity_id:entity_id,department_id:department_id,role_id:role}},type:"POST",dataType:"json",success:function(data){if(data.result){if($("#manage-left-menu li.active").attr("number")==role){var object=data.object;$("#manage-sort-list").prepend($("<li />").attr("id",object.id).append($("<p />").addClass("sort-handle").text(":")).append($("<input type='checkbox'/>")).append($("<table />").addClass("group").append($("<tr />").append($("<td />").text(object.first_name).addClass("user-manage-name")).append($("<td />").text(object.title).addClass("user-manage-title")).append($("<td />").text(department_name).addClass("user-manage-department").attr("value",object.department_id)).append($("<td />").text(entity_name).addClass("user-manage-entity").attr("value",object.entity_id)).append($("<td />").text(object.role).addClass("user-manage-authority").attr("value",object.role_id))).append($("<tr />").append($("<td />").text(object.email).addClass("user-manage-mail")).append($("<td />").text(I18n.t("manage.user.new.title"))).append($("<td />").text(I18n.t("manage.user.new.department"))).append($("<td />").text(I18n.t("manage.user.new.entity"))).append($("<td />").text(I18n.t("manage.user.new.departments"))).append($("<td />").text(I18n.t("manage.user.new.authority")))))),$("#manage-sort-list input[type='checkbox']").iCheck({checkboxClass:"icheckbox_minimal-aero"}),$("#manage-sort-list input[type='checkbox']").on("ifChanged",function(){$(this).parent().hasClass("checked")?(MANAGE.totalChecked-=1,total_check_listener()):(MANAGE.totalChecked+=1,total_check_listener())}),$("#manage-sort-list li").on("resize",function(){MANAGE.resize_sort_table()}),MANAGE.judge_kpi_count(),MANAGE.sort_init(),MANAGE.resize_sort_table(),MANAGE.user.icheck.init(),$("#assign-kpi-user").append($("<oprion />").attr("value",object.id).text(object.email)),$("#assign-kpi-user").val("").trigger("chosen:updated")}MANAGE.user.user_add_close()}else{var errmsg="";data.content.hasOwnProperty("email")&&(errmsg=errmsg+"邮箱："+data.content.email[0]+";"),data.content.hasOwnProperty("password")&&(errmsg=errmsg+"  密码："+data.content.password[0]+";"),data.content.hasOwnProperty("password_confirmation")&&(errmsg=errmsg+"  密码确认："+data.content.password_confirmation[0]+";"),MessageBox(errmsg,"top","warning")}}}):MessageBox("Please fill all the blanket taking *","top","warning")},MANAGE.user.user_edit_box_bind=function(){var $target=$("#manage-sort-list .icheckbox_minimal-aero.checked"),name=$target.next().find(".user-manage-name").text(),mail=$target.next().find(".user-manage-mail").text(),title=$target.next().find(".user-manage-title").text(),department_id=$target.next().find(".user-manage-department").attr("value"),entity_id=$target.next().find(".user-manage-entity").attr("value"),authority=$target.next().find(".user-manage-authority").attr("value");$("#user-edit #edit-user-name").val(name),$("#user-edit #edit-user-mail").val(mail),$("#user-edit #edit-user-title").val(title),$("#user-edit input[type='radio'][value='"+authority+"']").iCheck("check"),$("#manage-user-edit-old").attr("effect_on",$target.parent().attr("id")),$("#edit-department-for-kpi option[value='"+department_id+"']").prop("selected",!0),$("#edit-department-for-kpi").trigger("chosen:updated"),$("#edit-entity-for-kpi option[value='"+entity_id+"']").prop("selected",!0),$("#edit-entity-for-kpi").trigger("chosen:updated")},MANAGE.user.edit=function(){var edit_name=$("#user-edit #edit-user-name").val(),edit_mail=$("#user-edit #edit-user-mail").val(),edit_authority=$("#user-edit input[name='edit-user-role']:checked").attr("value"),edit_id=$("#manage-user-edit-old").attr("effect_on"),password=$("#user-edit #edit-user-password").val(),$target=$("#manage-sort-list").find("#"+edit_id),entity_id=$("#edit-entity-for-kpi :selected").attr("value"),entity_name=$("#edit-entity-for-kpi :selected").text(),department_id=$("#edit-department-for-kpi :selected").attr("value"),department_name=$("#edit-department-for-kpi :selected").text(),title=$("#user-edit #edit-user-title").val();$.trim(edit_name).length>0&&edit_mail.length>0?0==$("#user-edit>div>input").filter("[red='true']").length?($.ajax({url:"/users",type:"PUT",data:{id:$("#manage-sort-list").find(":checked").parent().parent().attr("id"),user:{first_name:edit_name,email:edit_mail,title:title,password:password,role_id:edit_authority,entity_id:entity_id,department_id:department_id}},dataType:"json",success:function(data){if(data.result){var object=data.object;$target.find(".user-manage-name").text(object.first_name),$target.find(".user-manage-mail").text(object.email),$target.find(".user-manage-title").text(object.title),$target.find(".user-manage-entity").attr("value",object.entity_id),$target.find(".user-manage-department").attr("value",object.department_id),$target.find(".user-manage-department").text(department_name),$target.find(".user-manage-entity").text(entity_name),"false"==$("#manage-sort-list").find(":checked").parent().parent().attr("is_tenant")&&$target.find(".user-manage-authority").text(object.role).attr("value",object.role_id)}else MessageBox("Something get wrong","top","wrong")}}),MANAGE.user.user_edit_close()):MessageBox("Please fix the input with red border","top","danger"):MessageBox("Please fill all the blanket taking *","top","warning")},MANAGE.user.assign={},MANAGE.user.kpis=function(id){$.ajax({url:"/kpis/user/"+id,dataType:"html",success:function(kpis){$("#assign-kpi-inner").html(kpis)}})},MANAGE.user.assign.init=function(){$("#manage-user-delivery").on("click",MANAGE.user.assign.initial),$("body").on("change","#assign-kpi-user",function(){var id=$(this).find(":selected").attr("value");MANAGE.user.kpis(id)}),$("body").on("change","#kpi-category",function(event){var id=$(adapt_event(event).target).attr("value");$.ajax({url:"/kpis/categoried/"+id,dataType:"json",success:function(data){$("#assign-kpi-list").empty();for(var i=0;i<data.length;i++)$("#assign-kpi-list").append($("<li />").append($("<h3 />").attr("kpi_id",data[i].id).text(data[i].name)).append($("<p />").attr("title",data[i].description).text(data[i].description)))}})}),$("#assign-kpi-category-btn").on("click",function(){var category=$("#kpi-category :selected").attr("value"),user=$("#assign-kpi-user :selected").attr("value");null!=category&&""!=category&&null!=user&&""!=user&&$.post("/kpis/assign",{kpi:category,user:user},function(msg){msg.result?MANAGE.user.kpis(user):MessageBox(msg.content,"top","warning")},"json")}),$("body").on("click","#assign-kpi-list>li>h3",function(){var id=$(this).attr("kpi_id"),validate=($(this).text(),$(this).next().text(),!0);if($("#assign-kpi-user :selected").text().length>0)if($("#assign-kpi-inner>.left>li").each(function(){return $(this).attr("kpi_id")==id?(validate=!1,!1):void 0}),validate){var user_id=$("#assign-kpi-user :selected").attr("value");$.ajax({url:"/kpis/assign",dataType:"json",data:{kpi:id,user:user_id,by_cate:!1},type:"post",success:function(msg){if(msg.result){var data=msg.content;$("#assign-kpi-inner>.left").append($("<li />").attr("id",data[0].id).attr("kpi_id",data[1].id).append($("<table />").append($("<tr />").append($("<td />").text(data[1].name)).append($("<td />").append($("<input type='text'/>").val(data[1].target_max).attr("kpi_id",data[0].id))).append($("<td />").append($("<input type='text'/>").val(data[1].target_min).attr("kpi_id",data[0].id)))).append($("<tr />").append($("<td />").text(data[1].description)).append($("<td />").text("Target Max")).append($("<td />").text("Target Min")))).append($("<i />").addClass("icon-trash")))}else MessageBox(msg.content,"top","warning")}})}else MessageBox(I18n.t("fix.kpi_assign_fail"),"top","warning")}),$("body").on("click","#assign-kpi-inner>ul>li>i",function(){if(confirm("Unassign this KPI ?")){var $target=$(this).parent();$.ajax({url:"/user_kpi_items/"+$target.attr("id"),dataType:"json",type:"DELETE",success:function(data){data.result&&$target.remove()}})}}),$("body").on("keyup","#assign-kpi-inner>ul>li input[type='text']",function(event){clearNoNumZero(adapt_event(event).target)}),$("body").on("keyup","#assign-kpi-inner>ul>li input[type='text']",function(event){var e=adapt_event(event).event;13==e.keyCode&&$(this).blur()}),$("body").on("blur","#assign-kpi-inner>ul>li input[type='text']",MANAGE.user.assign.input),$("body").on("click","#assign-kpi-cancel",MANAGE.user.assign.close)},MANAGE.user.assign.initial=function(){$("#assign-kpi-wrap").css("display","block"),$("#kpi-category+div").css("width","180px"),$("#assign-kpi-user+div").css("width","180px"),$.ajax({url:"/kpi_categories/list",dataType:"json",success:function(data){for(var i=0;i<data.length;i++)$("#kpi-category").append($("<option />").attr("value",data[i].id).text(data[i].name));$("#kpi-category").prepend($("<option />").attr("value","")),$("#kpi-category").val("").trigger("chosen:updated")}})},MANAGE.user.assign.close=function(){$("#assign-kpi-list").empty(),$("#assign-kpi-inner").empty(),$("#assign-kpi-user").val("").trigger("chosen:updated"),$("#kpi-category option").remove(),$("#kpi-category").val("").trigger("chosen:updated"),$("#assign-kpi-wrap").css("display","none")},MANAGE.user.assign.input=function(event){var target=adapt_event(event).target,id=$(target).attr("kpi_id"),target_max=$("#"+id).find(".target_max").val(),target_min=$("#"+id).find(".target_min").val();$.ajax({url:"/user_kpi_items",type:"PUT",data:{id:id,user_kpi_item:{target_max:target_max,target_min:target_min}},success:function(data){data.result||MessageBox(data.content,"top","warning")}})};