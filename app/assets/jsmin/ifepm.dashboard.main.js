function reload(id){return function(){if(ifepm.dashboard.graphs[id]){var last_update=(new Date).toWayneString().second;ifepm.dashboard.graphs[id].last_update=last_update,ifepm.dashboard.set_last_update_time(id,ifepm.dashboard.graphs[id].last_update),$.ajax({before_send:function(){},url:ifepm.config.get_item_data_url.url,data:{id:id,last_update:last_update},dataType:ifepm.config.get_item_data_url.dataType,crossDomain:ifepm.config.get_item_data_url.crossDomain,success:function(data){data&&ifepm.dashboard.update_graph(data,id)}})}}}function Condition(){this.id=null,this.entity_group=null,this.kpi_id=null,this.kpi_name=null,this.calculate_type=null,this.from=null,this.end=null,this.count=null}function Graph(){this.id=null,this.title=null,this.sequence=null,this.row=null,this.col=null,this.sizex=null,this.sizey=null,this.last_update=null,this.chart_type=null,this.placeholder=ifepm.template.view_placeholder,this.container=function(graph_item){var id,item_container_id;return isfullsize?(id="full_"+graph_item.id,item_container_id=ifepm.dashboard.make_item_container_id_full(graph_item.id)):(id=graph_item.id,item_container_id=ifepm.dashboard.make_item_container_id(graph_item.id)),ifepm.template.view.replace(/custom_handler/g,ifepm.config.remove_view_function).replace(/!item_id!/g,id).replace(/!id!/g,graph_item.id).replace(/!title!/g,graph_item.title).replace(/!item_container_id!/g,item_container_id).replace(/!attr!/g,ifepm.config.graph_indicator).replace(/!last_update!/g,graph_item.last_update)}}Date.prototype.toArray||(Date.prototype.toArray=function(){return[this.getFullYear(),this.getMonth()+1,this.getDate(),this.getHours(),this.getMinutes(),this.getSeconds(),this.getMilliseconds()]});var ifepm=ifepm||{};ifepm.dashboard=ifepm.dashboard||{},ifepm.active_selector=ifepm.active_selector||new ActiveSelect,ifepm.dashboard.form_chart=function(){},ifepm.dashboard.graphs=ifepm.dashboard.graphs||{},ifepm.dashboard.graph_sequence=[],ifepm.dashboard.set_last_update_time=function(item_id,lastupdate_time){var id=item_id;isfullsize&&(id="full_"+item_id);$("li#"+id+" .update-time").text(lastupdate_time)};var isformchart=!1;ifepm.dashboard.form_graph=function(datas,id){var container,outer;isfullsize?(container=ifepm.dashboard.make_item_container_id_full(id),outer=ifepm.dashboard.make_item_outer_id_full(id)):(container=ifepm.dashboard.make_item_container_id(id),outer=ifepm.dashboard.make_item_outer_id(id));var data,series_id,option,type=ifepm.dashboard.graphs[id].chart_type,chart=null;if(datas.length<1)return dashboard_remove_loading(outer),void ifepm.dashboard.on_finish_load();for(var i=0;i<datas.length;++i){data=[],series_id=i;for(var j=0;j<datas[i].current.length;++j)data[j]={},data[j].y=datas[i].current[j],data[j].high=datas[i].target_max[j],data[j].low=datas[i].target_min[j],data[j].unit=datas[i].unit[j],data[j].id=series_id;if(option={kpi:datas[i].kpi_name,id:series_id,target:container,outer_target:outer,begin_time:datas[i].startTime,type:type,interval:datas[i].interval,data:data,count:i+1,view_text:datas[i].view,total:datas[0].total},isfullsize){option.theme="dark";var $target=$("#"+option.outer_target).parent().parent();$target.find(".dashboard-eachDetail p").css("color","white"),$target.find(".dashboard-eachDetail i").css("color","white"),$target.find(".dashboard-eachDetail i").hover(function(){$(this).css("color","black")}),$target.find(".dashboard-eachDetail span").css("color","white")}0==i&&("pie"==option.type&&(high_chart.plotOptions.pie.size="70%"),render_to(option),create_environment_for_data(option),chart=new Highcharts.Chart(high_chart)),add_series(option),proper_type_for_chart(option),DASHBOARD.add.generate(option)}if(limit_pointer_number(option),1==datas.length&&"line"==type){var option_area={};option_area=deepCopy(option,option_area),option_area.type="arearange",option_area.id="line-target",option_area.count=1,add_series(option_area),proper_type_for_chart(option_area)}if(chart&&"pie"==type)for(var i=0;i<chart.series.length;++i)chart.series[i].update({showInLegend:!1});dashboard_remove_loading(outer),ifepm.dashboard.on_finish_load()};var intervals=[];ifepm.dashboard.setTimer=function(graph){var interval=null,intv=ifepm.dashboard.getInteral(graph.sequence);interval=setInterval(reload(graph.id),intv),intervals.push(interval),console.log("ID:"+graph.id+" Interval:"+interval)},ifepm.dashboard.clear_all_timer=function(){for(var i=0;i<intervals.length;i++)clearTimeout(intervals[i]);intervals=[]},ifepm.dashboard.getInteral=function(interval){var intvl=null,min=6e4,hour=36e5;switch(intvl=30*min,interval){case"90":intvl=30*min;break;case"100":intvl=60*hour;break;case"200":intvl=1*hour;break;case"300":intvl=24*hour;break;case"400":intvl=24*hour;break;case"500":intvl=24*hour;break;default:intvl=30*min}return intvl},ifepm.dashboard.update_graph=function(datas,id){var container;container=isfullsize?ifepm.dashboard.make_item_container_id_full(id):ifepm.dashboard.make_item_container_id(id);var type=ifepm.dashboard.graphs[id].chart_type,chart=$("#"+container).highcharts();if(chart){for(var i=0;i<datas.length;i++){var series=chart.get(i);if(series)for(var j=0;j<datas[i].current.length;j++){{series.data[j]}series.data[j].update(datas[i].current[j],!1)}}"pie"==type?pie_for_dashboard(container):chart.redraw()}},ifepm.dashboard.load_graph=function(id){if(ifepm.dashboard.graphs[id]){var outer,current_graph=ifepm.dashboard.graphs[id];outer=isfullsize?ifepm.dashboard.make_item_outer_id_full(id):ifepm.dashboard.make_item_outer_id(id),dashboard_show_loading(outer),$.ajax({before_send:function(){},url:ifepm.config.get_item_data_url.url,data:{id:id,last_update:current_graph.last_update},dataType:ifepm.config.get_item_data_url.dataType,crossDomain:ifepm.config.get_item_data_url.crossDomain,success:function(data){data&&ifepm.dashboard.form_graph(data,id)}})}},ifepm.dashboard.make_item_container_id=function(item_id){return"container_"+item_id},ifepm.dashboard.make_item_outer_id=function(item_id){return"container_"+item_id+"_outer"},ifepm.dashboard.make_item_container_id_full=function(item_id){return"container_full_"+item_id},ifepm.dashboard.make_item_outer_id_full=function(item_id){return"container_full_"+item_id+"_outer"},ifepm.dashboard.update_item_sequence=function(container_selector){ifepm.dashboard.graph_sequence=[],$(container_selector).children().filter(ifepm.config.graph_container_tag).each(function(){ifepm.dashboard.graph_sequence.push($(this).attr(ifepm.config.graph_indicator))}),$.ajax({url:ifepm.config.update_sequence_url.url,dataType:ifepm.config.update_sequence_url.dataType,crossDomain:ifepm.config.update_sequence_url.crossDomain,data:{sequence:ifepm.dashboard.graph_sequence}})};var current_index=0;ifepm.dashboard.on_finish_load=function(){var container_selector=ifepm.config.container_selector;if(++current_index,current_index>=ifepm.dashboard.graph_sequence.length)return ifepm.dashboard_widget.enable(!0),void(isfullsize&&(ifepm.dashboard.on_drag_stop(),$("#dash-fullsize").height(),window.setTimeout(function(){var height=$(document).height();$("#dashboard-content-full").css("height",height+"px")},100)));var graph_id=ifepm.dashboard.graph_sequence[current_index];null==ifepm.dashboard.graphs[graph_id].last_update&&(ifepm.dashboard.graphs[graph_id].last_update=(new Date).toWayneString().second),$(container_selector).append(ifepm.dashboard.graphs[graph_id].container(ifepm.dashboard.graphs[graph_id]));var option={};if(option.container_selector=container_selector,option.id=graph_id,isfullsize)if(ifepm.dashboard.graphs[graph_id].col)option.isnew=!1,option.row=ifepm.dashboard.graphs[graph_id].row,option.col=ifepm.dashboard.graphs[graph_id].col,option.sizex=ifepm.dashboard.graphs[graph_id].sizex,option.sizey=ifepm.dashboard.graphs[graph_id].sizey,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type,ifepm.dashboard_widget.add_w(option);else{option.isnew=!0,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type;var result=ifepm.dashboard_widget.add_w(option);ifepm.dashboard.graphs[graph_id].col=result.col,ifepm.dashboard.graphs[graph_id].row=result.row,ifepm.dashboard.graphs[graph_id].sizex=result.sizex,ifepm.dashboard.graphs[graph_id].sizey=result.sizey}else option.isnew=!0,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type,ifepm.dashboard_widget.add_w(option);isfullsize||ifepm.dashboard.setTimer(ifepm.dashboard.graphs[graph_id])},ifepm.dashboard.create_dashboard=function(){var container_selector=ifepm.config.container_selector;if(ifepm.dashboard_widget.remove_all_widgets(),ifepm.dashboard.clear_all_timer(),$(container_selector).children().remove(),Object.keys(ifepm.dashboard.graphs).length>0){current_index=0;var graph_id=ifepm.dashboard.graph_sequence[current_index];null==ifepm.dashboard.graphs[graph_id].last_update&&(ifepm.dashboard.graphs[graph_id].last_update=(new Date).toWayneString().second),$(container_selector).append(ifepm.dashboard.graphs[graph_id].container(ifepm.dashboard.graphs[graph_id]));var option={};option.container_selector=container_selector,option.id=graph_id,option.isnew=!0,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type;var result=ifepm.dashboard_widget.add_w(option);ifepm.dashboard.graphs[graph_id].sizex=result.sizex,ifepm.dashboard.graphs[graph_id].sizey=result.sizey}else $(container_selector).append((new Graph).placeholder)},ifepm.dashboard.init=function(id,callback){ifepm.dashboard.graphs={},ifepm.dashboard.graph_sequence=[],$.ajax({crossDomain:ifepm.config.get_dashboard_items_url.crossDomain,dataType:ifepm.config.get_dashboard_items_url.dataType,url:ifepm.config.get_dashboard_items_url.url,data:{id:id},success:function(data){ifepm.dashboard_widget.enable(!1),ifepm.dashboard.clear_all_timer();for(var i in data){var graph_item=new Graph;graph_item.id=data[i].id,graph_item.title=data[i].title,graph_item.chart_type=data[i].chart_type,graph_item.sequence=data[i].sequence,graph_item.dashboard_id=data[i].dashboard_id,graph_item.row=data[i].row,graph_item.col=data[i].col,graph_item.sizex=data[i].sizex,graph_item.sizey=data[i].sizey,graph_item.last_update=data[i].last_update,ifepm.dashboard.graphs[data[i].id]=graph_item,ifepm.dashboard.graph_sequence.push(data[i].id)}callback&&callback.call()},error:function(){alert("Oops, something went wrong, please try again")}})},ifepm.dashboard.on_view_added=function(data){var graph_item=new Graph;graph_item.id=data.id,graph_item.name=data.name,graph_item.title=data.title,graph_item.calculate_type=data.calculate_type,graph_item.from=data.start,graph_item.end=data.end,graph_item.chart_type=data.chart_type,graph_item.entity_group=data.entity_group,graph_item.kpi_id=data.kpi_id,graph_item.kpi_name=data.kpi_name,graph_item.interval=data.interval,graph_item.sequence=data.sequence,graph_item.dashboard_id=data.dashboard_id,graph_item.last_update=data.last_update;var container_selector=ifepm.config.container_selector,option={};option.isnew=!0,option.id=data.id,option.container_selector=container_selector,option.chart_type=data.chart_type,ifepm.dashboard.graphs[graph_item.id]=graph_item,ifepm.dashboard.graph_sequence.push(graph_item.id),$(container_selector).append(graph_item.container(graph_item));var result=ifepm.dashboard_widget.add_w(option);graph_item.sizex=result.sizex,graph_item.sizey=result.sizey,ifepm.dashboard.graphs[graph_item.id]=graph_item,ifepm.dashboard.setTimer(graph_item);var options=[],opt={};opt.id=graph_item.id,opt.sizex=graph_item.sizex,opt.sizey=graph_item.sizey,opt.col=graph_item.col,opt.row=graph_item.row,options.push(opt),ifepm.dashboard.save_grid_pos(options,{success:function(){}})},ifepm.dashboard.on_drag_stop=function(){var result={},options=[];for(var i in ifepm.dashboard.graph_sequence){var id=ifepm.dashboard.graph_sequence[i];if(null!=id){var opt={},filter="#full_"+id;result=ifepm.dashboard_widget.get_pos(filter),(ifepm.dashboard.graphs[id].row!=result.row||ifepm.dashboard.graphs[id].col!=result.col)&&(ifepm.dashboard.graphs[id].row=result.row,ifepm.dashboard.graphs[id].col=result.col,opt.id=id,opt.row=result.row,opt.col=result.col,opt.sizex=ifepm.dashboard.graphs[id].size_x,opt.sizey=ifepm.dashboard.graphs[id].size_y,options.push(opt))}}options.length>0&&ifepm.dashboard.save_grid_pos(options,{success:function(){}})},ifepm.dashboard.on_view_deleted=function(id){var need_delete_full_size=!1;current_select_id==ifepm.dashboard.graphs[id].dashboard_id&&(need_delete_full_size=!0),delete ifepm.dashboard.graphs[id];var value=Number(id),index=ifepm.dashboard.graph_sequence.indexOf(value);index>=0&&ifepm.dashboard.graph_sequence.splice(index,1);var filter;need_delete_full_size&&(filter=ifepm.config.container_selector_full+" #full_"+id,ifepm.dashboard_widget.remove_w(filter,!0)),filter=ifepm.config.container_selector+" #"+id,ifepm.dashboard_widget.remove_w(filter,!1)},ifepm.dashboard.delete=function(id,options){$.ajax({url:ifepm.config.dashboard_delete_url.url,crossDomain:ifepm.config.dashboard_delete_url.crossDomain,dataType:ifepm.config.dashboard_delete_url.dataType,data:{id:id},success:options.success,error:options.error,complete:options.complete})},ifepm.dashboard.add=function(dashboard,options){$.ajax({url:ifepm.config.dashboard_create_url.url,crossDomain:ifepm.config.dashboard_create_url.crossDomain,dataType:ifepm.config.dashboard_create_url.dataType,data:{data:dashboard},success:options.success,error:options.error,complete:options.complete})},ifepm.dashboard.delete_item=function(item_id,options){$.ajax({url:ifepm.config.dashboard_item_delete_url.url,crossDomain:ifepm.config.dashboard_item_delete_url.crossDomain,data:{id:item_id},dataType:ifepm.config.dashboard_item_delete_url.dataType,success:options.success,error:options.error,complete:options.complete})},ifepm.dashboard.add_item=function(dashboard_item,options){$.ajax({url:ifepm.config.dashboard_item_create_url.url,data:{dashboard_item:dashboard_item.db,conditions:dashboard_item.conditions},crossDomain:ifepm.config.dashboard_item_create_url.crossDomain,dataType:ifepm.config.dashboard_item_create_url.dataType,success:options.success,error:options.error,complete:options.complete})},ifepm.dashboard.save_grid_pos=function(sequence,options){$.ajax({url:"/dashboard_items/save_grid",data:{sequence:sequence},type:"POST",success:options.success,error:options.error,complete:options.complete})},ifepm.dashboard.on_dashboard_deleted=function(id){if(current_dashboard_id==id){var container_selector=ifepm.config.container_selector;ifepm.dashboard_widget.remove_all_widgets(isfullsize),$(container_selector).children().remove()}};var isfullsize=!1,current_select_id=-1;ifepm.dashboard.full_size=function(option){if(isfullsize=option.fullsize,current_select_id=option.id,isfullsize){var container_selector=ifepm.config.container_selector_full;if(ifepm.dashboard_widget.remove_all_widgets(isfullsize),$(container_selector).children().remove(),Object.keys(ifepm.dashboard.graphs).length>0){current_index=0;var graph_id=ifepm.dashboard.graph_sequence[current_index];$(container_selector).append(ifepm.dashboard.graphs[graph_id].container(ifepm.dashboard.graphs[graph_id]));var option={};option.container_selector=container_selector,option.id=graph_id,ifepm.dashboard.graphs[graph_id].col?(option.isnew=!1,option.col=ifepm.dashboard.graphs[graph_id].col,option.row=ifepm.dashboard.graphs[graph_id].row,option.sizex=ifepm.dashboard.graphs[graph_id].sizex,option.sizey=ifepm.dashboard.graphs[graph_id].sizey,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type):(option.isnew=!0,option.chart_type=ifepm.dashboard.graphs[graph_id].chart_type);var result=ifepm.dashboard_widget.add_w(option);option.isnew&&(ifepm.dashboard.graphs[graph_id].col=result.col,ifepm.dashboard.graphs[graph_id].row=result.row,ifepm.dashboard.graphs[graph_id].sizex=result.sizex,ifepm.dashboard.graphs[graph_id].sizey=result.sizey)}}};