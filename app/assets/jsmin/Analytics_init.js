function init_analytics(){$("input[type='radio']").iCheck({radioClass:"iradio_minimal-aero"});var target="#analy-begin-time,#analy-end-time";$("#chart-kpi").chosen().change(function(){var interval=$("#chart-kpi").find(":selected").attr("interval");$(target).val(""),$(".index-date-extra-info").text(""),new DATE_PICKER[interval](target,"date").datePicker()}),$("#chart-group").chosen().change(function(){$("#analy-begin-time,#analy-end-time").datepicker("remove"),$("#analy-begin-time,#analy-end-time").datetimepicker("remove")}),$("body").on("change","#analy-begin-time",function(){var interval=$("#chart-kpi").find(":selected").attr("interval");if("200"==interval){var week=standardParse($(this).val()).date.toWeekNumber();$(this).next().text("week "+week)}else if("400"==interval){var quarter=standardParse($(this).val()).date.monthToQuarter();$(this).next().text("quarter "+quarter)}}).on("change","#analy-end-time",function(){var interval=$("#chart-kpi").find(":selected").attr("interval");if("200"==interval){var week=standardParse($(this).val()).date.toWeekNumber();$(this).next().text("week "+week)}else if("400"==interval){var quarter=standardParse($(this).val()).date.monthToQuarter();$(this).next().text("quarter "+quarter)}}),resize_chart.body(),resize_chart.container(),$("#chart-group").prepend($("<option />").attr("value","")),$("#chart-group").val("").trigger("chosen:updated"),$("#chart-kpi").val("").trigger("chosen:updated"),$("#chart-view").prepend($("<option />").attr("value","")),$("#chart-view").val("").trigger("chosen:updated"),$("#chart-group").on("change",function(event){var id=$(adapt_event(event).target).attr("value");$.ajax({url:"/kpis/categoried/"+id,dataType:"json",success:function(data){$("#chart-kpi").empty().trigger("chosen:updated");for(var i=0;i<data.length;i++)$("#chart-kpi").append($("<option />").attr("value",data[i].id).attr("interval",data[i].frequency).text(data[i].name));$("#chart-kpi").prepend($("<option />").attr("value","")),$("#chart-kpi").val("").trigger("chosen:updated")}})})}function analytic_control_condition_visible(){var open_state=$("#analytic-control-condition-visible").attr("state");"open"==open_state?($("#analytics-condition").css("top","-16px"),$("#chart-body").css("top","26px").height(parseInt($("#chart-body").height())+86),$("#analytics-condition-invisible-mark").css("display","block"),$("#analytic-control-condition-visible").attr("state","close").removeClass("icon-chevron-up").addClass("icon-chevron-down")):($("#analytics-condition").css("top","70px"),$("#chart-body").css("top","112px").height(parseInt($("#chart-body").height())-87),$("#analytics-condition-invisible-mark").css("display","none"),$("#analytic-control-condition-visible").attr("state","open").removeClass("icon-chevron-down").addClass("icon-chevron-up")),resize_chart.container()}function prepare_form_chart(){var interval,type,chart_body_close_validate,kpi=$("#chart-kpi :selected").attr("value"),view=$("#chart-view :selected").attr("value"),view_text=$("#chart-view :selected").text(),method=$("input[name='chartRadios']:checked").attr("value");"block"==$("#chart-body").css("display")?(chart_body_close_validate=!1,interval=$("#chart-interval-alternate").find(".active").attr("interval"),type=$("#chart-type-alternate").find(".image").attr("type")):(chart_body_close_validate=!0,interval=void 0==$("#analy-begin-time").attr("interval")||0==$("#analy-begin-time").attr("interval").length?$("#chart-kpi :selected").attr("interval"):$("#analy-begin-time").attr("interval"),type="line");var begin_time=$("#analy-begin-time").attr("hide_value"),end_time=$("#analy-end-time").attr("hide_value");if(kpi&&begin_time&&view){if(end_time){var compare_result=compare_time(begin_time,end_time);begin_time=compare_result.begin,end_time=compare_result.end}else end_time=begin_time;var option={kpi:$("#chart-kpi :selected").text(),kpi_id:kpi,target:"chart-container",begin_time:begin_time,end_time:end_time,type:type,interval:interval,count:ANALYTICS.chartSeries.count+1,view:view,view_text:view_text,method:method,chart_body_close_validate:chart_body_close_validate};ANALYTICS.chartSeries.addCount(),ANALYTICS.chartSeries.id_give(),option.id=ANALYTICS.chartSeries.id,ANALYTICS.chartSeries.addSeries(option),option.chart_body_close_validate&&show_chart_body(option),ANALYTICS.form_chart(option)}else MessageBox("please fill all blanks in *","top","warning")}function show_chart_body(option){$("#chart-body").css("display","block"),$("body").on("click","#chart-type-alternate td",function(event){alternate_chart_type(event)}),$("#chart-interval-alternate").find("li").each(function(){$(this).bind("click",function(event){var target=adapt_event(event).target;if(!$(target).hasClass("active")){var option={interval:$(target).attr("interval"),target:"chart-container",type:$("#chart-type-alternate").find(".image").attr("type")};change_interval(option),$("#chart-interval-alternate").find("li").removeClass("active"),$(target).addClass("active")}})}),$("#chart-interval-alternate").find("li[interval='"+option.interval+"']").addClass("active")}function alternate_chart_type(event){if(1==ANALYTICS.loading_data)MessageBox("Can't do it during loading","top","warning");else{var target=adapt_event(event).target;if(!$(target).hasClass("image")){for(var option={target:"chart-container",type:$(target).attr("type"),count:ANALYTICS.chartSeries.getCount(),interval:$("#chart-interval-alternate li.active").attr("interval")},i=0;i<ANALYTICS.chartSeries.series.length;i++)void 0!==ANALYTICS.chartSeries.series[i]&&(option.id=i,ANALYTICS.proper_type_for_chart(option));$(target).siblings().removeClass("image"),$("#chart-type-alternate td").find("p").css("display","block"),$(target).addClass("image").find("p").css("display","block")}}}function change_interval(option){if(1==ANALYTICS.loading_data)MessageBox("Can't do it during loading","top","warning");else{for(var series_object,have_data=[],not_have_data=[],chart=$("#"+option.target).highcharts(),i=0;i<ANALYTICS.chartSeries.id_count;i++)void 0!==ANALYTICS.chartSeries.series[i]&&(series_object=ANALYTICS.chartSeries.series[i],series_object[option.interval]?have_data.push(i):not_have_data.push(i));chart.destroy();var j,option={target:"chart-container",type:option.type,interval:option.interval,count:ANALYTICS.chartSeries.getCount()};for(j=0;j<have_data.length;j++)option.kpi=ANALYTICS.chartSeries.series[j].kpi,option.id=j,option.begin_time=ANALYTICS.chartSeries.series[j].begin_time,option.data=ANALYTICS.chartSeries.series[j][option.interval],0==j&&(ANALYTICS.render_to(option),new Highcharts.StockChart(ANALYTICS.high_chart)),ANALYTICS.add_series(option),ANALYTICS.proper_type_for_chart(option);for(j=0;j<not_have_data.length;j++)option.kpi=ANALYTICS.chartSeries.series[j].kpi,option.kpi_id=ANALYTICS.chartSeries.series[j].kpi_id,option.method=ANALYTICS.chartSeries.series[j].method,option.view=ANALYTICS.chartSeries.series[j].view,option.id=j,option.begin_time=ANALYTICS.chartSeries.series[j].begin_time,option.end_time=ANALYTICS.chartSeries.series[j].end_time,0==have_data.length&&0==j?(option.chart_body_close_validate=!0,ANALYTICS.form_chart(option)):(option.chart_body_close_validate=!1,ANALYTICS.form_chart(option))}}function clear_chart_condition(){$("#analytics-condition").find("input[type='text']").each(function(){$(this).val("")}),$(".index-date-extra-info").text("")}function close_chart_detail(){$("#chart-point-detail").css("left","-300px"),$("#chart-container").css("left","0px")}function tcr_trend(judge){switch(judge){case"low":$("#tcr").attr("class",""),$("#tcr").addClass("tcr-trend low");break;case"middle":$("#tcr").attr("class",""),$("#tcr").addClass("tcr-trend middle");break;case"high":$("#tcr").attr("class",""),$("#tcr").addClass("tcr-trend high")}}var resize_chart={body:function(){$("#chart-body").height(parseInt($(window).height())-parseInt($("#analytics-condition").height())-parseInt($("#analytics-condition").css("top"))-3>=0?parseInt($(window).height())-parseInt($("#analytics-condition").height())-parseInt($("#analytics-condition").css("top"))-3:0)},container:function(){if($("#chart-main-middle").height(parseInt($("#chart-body").height())-parseInt($("#chart-interval-alternate").attr("my_height"))-parseInt($("#chart-type-alternate").attr("my_height"))-1),$("#chart-container").height(parseInt($("#chart-main-middle").height())),$("#chart-container").highcharts()){var chart=$("#chart-container").highcharts();chart.setSize($("#chart-main-middle").width(),$("#chart-main-middle").height(),!1)}if("pie"==$("#chart-type-alternate td.active").attr("type"))for(var k=0;k<$("#chart-container").highcharts().series.length;k++)$("#chart-container").highcharts().series[k].update({showInLegend:!1})}};